<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<style>
  body { background: #f8f9fa; }
  .checkout-card { max-width: 700px; margin: 40px auto; }
</style>
</head>
<body>

<div class="card checkout-card shadow">
  <div class="card-header bg-primary text-white">
    <h4>Checkout</h4>
  </div>
  <div class="card-body">
    <div id="cart-summary"></div>
    <form id="checkoutForm">
      <input type="text" id="name" class="form-control mb-2" placeholder="Full Name" required>
      <input type="email" id="email" class="form-control mb-2" placeholder="Email" required>
      <input type="tel" id="mobile" class="form-control mb-2" placeholder="Mobile" required>
      <textarea id="address" class="form-control mb-2" placeholder="Address" required></textarea>
      <input type="text" id="pincode" class="form-control mb-3" placeholder="Pincode" required>
      <button type="button" id="payBtn" class="btn btn-success w-100">Proceed to Payment</button>
    </form>
  </div>
</div>

<script>
const API_BASE = "https://cosmetic-store-pmrd.onrender.com";
function renderCart() {
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  if (cart.length === 0) {
    document.getElementById("cart-summary").innerHTML = "<p>Your cart is empty</p>";
    return;
  }
  let total = 0;
  let html = `<table class='table table-bordered'><tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr>`;
  cart.forEach(item => {
    let sub = item.qty * item.price;
    total += sub;
    html += `<tr><td>${item.name}</td><td>${item.qty}</td><td>₹${item.price}</td><td>₹${sub}</td></tr>`;
  });
  html += `<tr><th colspan="3">Total</th><th>₹${total}</th></tr></table>`;
  document.getElementById("cart-summary").innerHTML = html;
}
renderCart();

document.getElementById("payBtn").addEventListener("click", async () => {
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  if (cart.length === 0) return alert("Cart is empty");

  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  const address = document.getElementById("address").value.trim();
  const pincode = document.getElementById("pincode").value.trim();

  if (!name || !email || !mobile || !address || !pincode) {
    return alert("Please fill all fields");
  }

  const res = await fetch(`${API_BASE}/api/orders`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, email, mobile, address, pincode, items: cart })
  });
  const data = await res.json();
  if (!data.orderId) return alert("Order creation failed");

  const options = {
    key: data.key,
    amount: data.amount,
    currency: "INR",
    name: "Om Sai General Stores",
    order_id: data.orderId,
    handler: async function (response) {
      await fetch(`${API_BASE}/api/orders/confirm`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          razorpay_order_id: response.razorpay_order_id,
          razorpay_payment_id: response.razorpay_payment_id
        })
      });
      alert("Payment successful! Order placed.");
      localStorage.removeItem("cart");
      window.location.href = "my-orders.html";
    }
  };
  const rzp = new Razorpay(options);
  rzp.open();
});
</script>

</body>
</html>
