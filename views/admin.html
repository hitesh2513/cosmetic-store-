<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Om Sai General Stores</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f8f9fa;
      font-family: Arial, sans-serif;
    }
    h2 {
      text-align: center;
      margin-top: 20px;
      color: #343a40;
    }
    table {
      background: white;
    }
    select {
      width: 100%;
      padding: 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<div class="container mt-4">
  <h2>Admin Panel - All Orders</h2>
  <table class="table table-striped table-bordered mt-4">
    <thead class="table-dark">
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Mobile</th>
        <th>Address</th>
        <th>Pincode</th>
        <th>Items</th>
        <th>Date</th>
        <th>Payment Status</th>
        <th>Delivery Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="orderTable">
      <tr><td colspan="10" class="text-center">Loading orders...</td></tr>
    </tbody>
  </table>
</div>

<script>
const API_BASE = "https://cosmetic-backend-lt5t.onrender.com"; // ✅ Render backend URL

// ✅ Fetch all orders (with improved error handling)
async function fetchOrders() {
  try {
    const res = await fetch(`${API_BASE}/api/orders`, {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) throw new Error("Failed to fetch orders");

    const orders = await res.json();
    const table = document.getElementById("orderTable");

    if (!orders || orders.length === 0) {
      table.innerHTML = "<tr><td colspan='10' class='text-center'>No orders found.</td></tr>";
      return;
    }

    table.innerHTML = orders.map(o => `
      <tr>
        <td>${o.name || "-"}</td>
        <td>${o.email || "-"}</td>
        <td>${o.mobile || "-"}</td>
        <td>${o.address || "-"}</td>
        <td>${o.pincode || "-"}</td>
        <td>${Array.isArray(o.items) ? o.items.map(i => `${i.name} (x${i.qty})`).join("<br>") : "-"}</td>
        <td>${o.date ? new Date(o.date).toLocaleString() : "-"}</td>
        <td>${o.paymentStatus || "Pending"}</td>
        <td>${o.deliveryStatus || "Processing"}</td>
        <td>
          <select onchange="updateStatus('${o._id}', 'deliveryStatus', this.value)">
            <option disabled selected>Change Delivery</option>
            <option>Processing</option>
            <option>Shipped</option>
            <option>Out for Delivery</option>
            <option>Delivered</option>
          </select>
          <br>
          <select onchange="updateStatus('${o._id}', 'paymentStatus', this.value)">
            <option disabled selected>Change Payment</option>
            <option>Pending</option>
            <option>Paid</option>
            <option>Failed</option>
          </select>
        </td>
      </tr>
    `).join("");

  } catch (err) {
    console.error("Error loading orders:", err);
    document.getElementById("orderTable").innerHTML =
      "<tr><td colspan='10' class='text-center text-danger'>Error loading orders. Please try again later.</td></tr>";
  }
}

// ✅ Update order status
async function updateStatus(orderId, field, value) {
  try {
    const res = await fetch(`${API_BASE}/api/orders/${encodeURIComponent(orderId)}/status`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ [field]: value })
    });

    if (!res.ok) throw new Error("Update failed");
    alert("✅ Order status updated successfully!");
    fetchOrders();
  } catch (err) {
    console.error("Status update failed:", err);
    alert("❌ Failed to update order status.");
  }
}

// ✅ Load orders on page start
document.addEventListener("DOMContentLoaded", fetchOrders);
</script>

</body>
</html>
