<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>body{background:#f8f9fa}</style>
</head>
<body>

<div class="container mt-4">
  <h2 class="mb-4">Admin Panel - All Orders</h2>
  <table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Mobile</th>
        <th>Address</th>
        <th>Pincode</th>
        <th>Items</th>
        <th>Date</th>
        <th>Payment Status</th>
        <th>Delivery Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="orderTable"></tbody>
  </table>
</div>

<script>
const API_BASE = "http://localhost:5000";

async function fetchOrders() {
  try {
    const res = await fetch(`${API_BASE}/api/orders`);
    if (!res.ok) throw new Error("Failed to fetch orders");
    const orders = await res.json();

    const table = document.getElementById("orderTable");
    if (!orders.length) {
      table.innerHTML = "<tr><td colspan='10' class='text-center'>No orders found.</td></tr>";
      return;
    }

    table.innerHTML = orders.map(o => `
      <tr>
        <td>${o.name}</td>
        <td>${o.email || "-"}</td>
        <td>${o.mobile || "-"}</td>
        <td>${o.address}</td>
        <td>${o.pincode}</td>
        <td>${o.items.map(i => `${i.name} (x${i.qty})`).join("<br>")}</td>
        <td>${new Date(o.date).toLocaleString()}</td>
        <td>${o.paymentStatus}</td>
        <td>${o.deliveryStatus}</td>
        <td>
          <select onchange="updateStatus('${o._id}', 'deliveryStatus', this.value)">
            <option disabled selected>Change Delivery</option>
            <option>Processing</option>
            <option>Shipped</option>
            <option>Out for Delivery</option>
            <option>Delivered</option>
          </select><br>
          <select onchange="updateStatus('${o._id}', 'paymentStatus', this.value)">
            <option disabled selected>Change Payment</option>
            <option>Pending</option>
            <option>Paid</option>
            <option>Failed</option>
          </select>
        </td>
      </tr>
    `).join("");
  } catch (error) {
    console.error(error);
    document.getElementById("orderTable").innerHTML = "<tr><td colspan='10'>Error loading orders.</td></tr>";
  }
}

async function updateStatus(orderId, field, value) {
  try {
    const res = await fetch(`${API_BASE}/api/orders/${orderId}/status`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ [field]: value }),
    });
    if (!res.ok) throw new Error("Update failed");
    alert("Order status updated");
    fetchOrders();
  } catch (error) {
    alert("Failed to update order status");
    console.error(error);
  }
}

document.addEventListener("DOMContentLoaded", fetchOrders);
</script>

</body>
</html>
